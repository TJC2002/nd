# ND网盘 - 服务端功能点文档

## 1. 系统概述

服务端作为网盘系统的核心，负责处理所有后端逻辑，包括用户认证、文件存储管理、数据同步、API服务等。本文档详细列出服务端需要实现的功能点，确保系统稳定、高效运行。

## 2. 核心功能模块

### 2.1 账户与设备管理

#### 2.1.1 用户认证服务
- **登录验证**：验证用户账号密码，生成认证令牌（JWT）
- **免注册登录**：生成临时用户标识，绑定设备信息
- **密码找回**：处理密码找回请求，发送验证链接/验证码
- **账号注销**：删除用户数据，清理关联资源
- **令牌管理**：令牌生成、刷新、失效处理
- **权限验证**：API请求时验证令牌权限

#### 2.1.2 设备管理服务
- **设备注册**：记录新设备登录信息（设备类型、登录时间、IP地址）
- **设备列表查询**：根据用户ID查询关联设备列表
- **远程下线**：强制使指定设备的令牌失效，断开连接
- **设备状态更新**：实时更新设备在线/离线状态
- **设备历史记录**：存储设备登录历史，用于审计

### 2.2 核心存储与备份

#### 2.2.1 存储管理服务
- **存储节点管理**：
  - 多存储协议适配（本地路径、OSS、MinIO）
  - 存储节点健康检查
  - 存储节点启用/禁用
  - 存储节点容量监控
- **存储策略执行**：
  - 按规则分配文件存储位置（大文件存OSS、小文件存本地）
  - 存储节点负载均衡
  - 故障自动切换存储节点
- **容量管理**：
  - 用户容量上限设置
  - 容量使用统计
  - 容量预警触发

#### 2.2.2 同步服务
- **同步任务管理**：
  - 接收客户端同步请求
  - 处理文件增量同步
  - 解决同步冲突（按策略选择保留版本）
  - 同步进度跟踪
- **实时同步**：
  - 监听本地文件变更（通过客户端上报或服务端通知）
  - 触发云端文件更新
  - 推送同步通知到其他客户端
- **同步日志**：记录同步操作详情，用于问题排查

#### 2.2.3 离线下载服务
- **下载任务管理**：
  - 接收下载请求（HTTP/HTTPS、BT种子、磁力链接）
  - 创建下载任务，分配下载资源
  - 跟踪下载进度（分片下载、速度统计）
  - 处理下载完成/失败事件
- **下载队列**：
  - 管理并发下载任务数
  - 任务优先级调度
  - 队列状态监控
- **文件处理**：
  - 下载完成后将文件存入指定存储位置
  - 更新文件元数据
  - 通知客户端下载完成


### 2.3 文件管理与在线处理

#### 2.3.1 文件操作服务
- **基础操作**：
  - 创建文件夹
  - 文件上传（接收分片上传、合并分片）
  - 文件下载（生成下载链接、断点续传支持）
  - 文件移动（更新存储路径和元数据）
  - 文件删除（移至回收站或永久删除）
  - 文件重命名（更新元数据）
  - 批量操作处理（并发执行批量任务）
- **回收站管理**：
  - 回收站文件存储
  - 回收站文件恢复
  - 回收站文件永久删除
  - 回收站文件过期清理

#### 2.3.2 检索服务
- **索引管理**：
  - 文件元数据索引（文件名、类型、大小、时间）
  - 索引更新与优化
- **搜索处理**：
  - 接收搜索请求，解析搜索条件
  - 执行索引查询，返回匹配结果
  - 搜索结果排序（相关度、时间、大小）
  - 高级搜索（组合多个条件）

#### 2.3.3 在线预览服务
- **预览功能**：
  - 生成文件预览数据（文档转HTML、图片缩略图）
  - 处理视频/音频预览（生成封面、音频波形）

#### 2.3.4 格式转换与解压服务
- **格式转换**：
  - 接收转换请求（源文件、目标格式）
  - 调用转换工具执行转换（PDF与Office互转、图片格式转换、视频转码）
  - 处理转换进度和结果
  - 返回转换后文件
- **在线解压**：
  - 接收解压请求（压缩包文件、目标路径）
  - 执行在线解压（支持ZIP、RAR等格式）
  - 处理解压结果，更新文件结构
  - 通知客户端解压完成

### 2.4 分享

#### 2.4.1 分享服务
- **分享链接生成**：
  - 生成唯一分享链接（包含过期时间、密码等参数）
  - 存储分享链接元数据（文件ID、权限、有效期）
- **分享链接验证**：
  - 验证链接有效性（过期时间、密码）
  - 检查访问权限
- **分享链接管理**：
  - 撤销分享链接
  - 查询用户分享记录
  - 统计分享访问次数

### 2.5 音视频与内容消费

#### 2.5.1 媒体处理服务
- **视频处理**：
  - 视频转码（适配不同分辨率/格式）
  - 视频封面生成
  - 视频元数据提取（时长、分辨率等）
- **音频处理**：
  - 音频格式转换
  - 音频元数据提取（时长、比特率等）
- **流媒体服务**：
  - 提供视频/音频流媒体传输（支持断点续传、自适应码率）
  - 处理播放请求，返回流数据

#### 2.5.2 播放控制服务
- **播放状态管理**：
  - 记录用户播放进度
  - 跨设备同步播放进度
- **字幕服务**：
  - 处理内嵌字幕提取
  - 管理外挂字幕上传与存储
  - 提供字幕流数据
- **音轨管理**：
  - 提取视频多音轨信息
  - 提供音轨切换支持

#### 2.5.3 内容管理服务
- **专辑/歌单管理**：
  - 存储专辑/歌单元数据
  - 处理专辑/歌单的创建/编辑/删除
- **内容识别**：
  - 调用AI服务识别影音文件信息（影视剧名称、集数、歌手、专辑）
  - 自动更新文件元数据和命名

#### 2.5.4 投屏服务
- **设备发现**：
  - 接收客户端投屏设备搜索请求
  - 扫描局域网内可投屏设备
  - 返回设备列表
- **投屏控制**：
  - 处理投屏开始/停止请求
  - 转发播放控制指令（播放/暂停/进度调整）
  - 监控投屏状态

#### 2.5.5 AI辅助服务
- **AI任务管理**：
  - 接收客户端AI工具请求
  - 分配AI处理资源
  - 处理任务队列
- **具体AI功能**：
  - 图片OCR：调用OCR API提取文字
  - 证件排版：调用图像处理API执行排版
  - 试卷手写擦除：调用AI模型执行擦除
  - 文档摘要：调用NLP API生成摘要
  - 视频字幕：调用语音识别API生成字幕
- **结果处理**：
  - 存储AI处理结果
  - 返回结果给客户端

### 2.6 后端管理与系统监控

#### 2.6.1 后端管理服务
- **存储介质管理**：
  - 配置/添加存储介质（本地路径、OSS、MinIO）
  - 设置存储策略
  - 监控存储节点状态
- **文件元数据管理**：
  - 存储所有文件元数据（文件名、大小、哈希值、存储位置等）
  - 元数据索引优化
  - 元数据备份与恢复
- **秒传功能**：
  - 计算文件哈希值
  - 对比数据库中已存在的哈希值
  - 实现秒传逻辑（仅更新元数据）
- **用户存储空间管理**：
  - 配置用户存储空间上限
  - 监控用户容量使用情况
  - 调整用户容量
- **系统全局配置**：
  - 配置历史版本保留数量
  - 配置回收站文件保留时长
  - 配置离线下载任务数上限
  - 功能开关管理（启用/禁用特定功能）

#### 2.6.2 系统监控与日志
- **操作日志**：
  - 记录用户操作（登录/登出、文件上传/下载/删除）
  - 记录系统操作（存储节点变更、配置修改）
  - 记录错误信息
- **性能监控**：
  - 监控API响应时间
  - 监控存储节点I/O性能
  - 监控系统CPU/内存使用
- **安全监控**：
  - 检测异常登录（异地登录、多次失败登录）
  - 监控异常文件操作（大量文件删除、异常下载）
- **日志查询与导出**：
  - 提供日志查询接口
  - 支持日志导出（CSV、JSON格式）

## 3. API接口设计

### 3.1 认证接口
- **登录**：POST /api/auth/login
- **登出**：POST /api/auth/logout
- **密码找回**：POST /api/auth/forgot-password
- **令牌刷新**：POST /api/auth/refresh-token

### 3.2 设备管理接口
- **获取设备列表**：GET /api/devices
- **远程下线设备**：POST /api/devices/{deviceId}/logout

### 3.3 存储管理接口
- **获取存储状态**：GET /api/storage/status
- **获取存储节点**：GET /api/storage/nodes
- **更新存储节点**：PUT /api/storage/nodes/{nodeId}

### 3.4 文件管理接口
- **获取文件列表**：GET /api/files
- **上传文件**：POST /api/files/upload
- **下载文件**：GET /api/files/{fileId}/download
- **移动文件**：PUT /api/files/{fileId}/move
- **删除文件**：DELETE /api/files/{fileId}
- **重命名文件**：PUT /api/files/{fileId}/rename

### 3.5 同步接口
- **发起同步**：POST /api/sync/start
- **获取同步状态**：GET /api/sync/status
- **解决同步冲突**：POST /api/sync/resolve-conflict

### 3.6 离线下载接口
- **创建下载任务**：POST /api/downloads
- **获取下载任务列表**：GET /api/downloads
- **控制下载任务**：PUT /api/downloads/{taskId}/{action}（pause/resume/cancel）

### 3.7 分享接口
- **创建分享链接**：POST /api/shares
- **获取分享链接**：GET /api/shares
- **撤销分享链接**：DELETE /api/shares/{shareId}

### 3.8 媒体处理接口
- **获取媒体信息**：GET /api/media/{fileId}/info
- **开始格式转换**：POST /api/media/convert
- **获取转换状态**：GET /api/media/convert/{taskId}/status

### 3.9 AI工具接口
- **执行AI任务**：POST /api/ai/tasks
- **获取AI任务结果**：GET /api/ai/tasks/{taskId}/result

### 3.10 系统管理接口
- **获取系统配置**：GET /api/admin/config
- **更新系统配置**：PUT /api/admin/config
- **获取系统日志**：GET /api/admin/logs
- **获取用户列表**：GET /api/admin/users
- **更新用户配置**：PUT /api/admin/users/{userId}

## 4. 技术实现要点

### 4.1 架构设计
- **微服务架构**：将核心服务拆分为独立微服务（认证服务、存储服务、文件处理服务等）
- **API网关**：统一API入口，处理请求路由、认证和限流
- **消息队列**：使用RabbitMQ/Kafka处理异步任务（如离线下载、格式转换）
- **缓存层**：使用Redis缓存热点数据（如用户会话、文件元数据）
- **数据库**：使用MySQL/PostgreSQL存储用户数据和文件元数据，使用NoSQL存储非结构化数据

### 4.2 性能优化
- **分片上传/下载**：大文件分片处理，提升传输速度
- **CDN加速**：使用CDN缓存静态资源和常用文件，提升访问速度
- **异步处理**：耗时操作（如转码、OCR）后台异步执行
- **数据库优化**：使用索引、分库分表，提升查询性能
- **存储优化**：使用压缩、去重技术，节省存储空间

### 4.3 可靠性保障
- **数据备份**：定期备份用户数据和元数据
- **故障恢复**：存储节点故障自动切换，确保服务可用性
- **断点续传**：支持文件上传/下载断点续传，避免网络中断导致任务失败
- **幂等性设计**：API接口设计支持幂等操作，避免重复执行导致数据不一致

### 4.4 安全考虑
- **数据加密**：存储敏感数据时进行加密
- **HTTPS传输**：所有API请求使用HTTPS加密传输
- **访问控制**：严格的权限验证，确保用户只能访问自己的资源
- **速率限制**：限制API请求频率，防止DDoS攻击
- **输入验证**：对所有用户输入进行严格验证，防止注入攻击

## 5. 总结

服务端功能点覆盖了网盘系统的所有后端逻辑，重点关注系统的稳定性、可靠性和性能。通过实现以上功能点，服务端能够为客户端提供强大、高效的API支持，确保整个网盘系统的正常运行和用户体验的流畅性。