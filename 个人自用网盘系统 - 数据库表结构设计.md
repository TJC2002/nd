# ND网盘 - 数据库表结构设计

## 1. 账户与设备管理

### 1.1 users 表
- **id**：用户ID，主键
- **username**：用户名，唯一
- **password_hash**：密码哈希值
- **email**：邮箱
- **phone**：手机号
- **total_space**：总存储空间（字节）
- **used_space**：已用存储空间（字节）
- **created_at**：创建时间
- **updated_at**：更新时间
- **status**：用户状态（active/inactive）

### 1.2 devices 表
- **id**：设备ID，主键
- **user_id**：用户ID，外键关联users表
- **device_name**：设备名称
- **device_type**：设备类型（web/mobile/desktop）
- **device_identifier**：设备唯一标识
- **last_login_ip**：最后登录IP
- **last_login_time**：最后登录时间
- **status**：设备状态（online/offline）
- **created_at**：创建时间

### 1.3 device_logs 表
- **id**：日志ID，主键
- **user_id**：用户ID，外键关联users表
- **device_id**：设备ID，外键关联devices表
- **login_ip**：登录IP
- **login_time**：登录时间
- **logout_time**：登出时间
- **status**：登录状态（success/failed）

## 2. 核心存储与备份

### 2.1 files 表
- **id**：文件ID，主键
- **user_id**：用户ID，外键关联users表
- **parent_id**：父文件夹ID，自关联（根目录为0）
- **name**：文件名
- **size**：文件大小（字节）
- **hash_value**：文件哈希值（用于秒传）
- **file_type**：文件类型（文档/图片/视频/音频等）
- **storage_node_id**：存储节点ID，外键关联storage_nodes表
- **storage_path**：文件在存储节点中的路径
- **mime_type**：文件MIME类型
- **is_folder**：是否为文件夹（1/0）
- **created_at**：创建时间
- **updated_at**：更新时间
- **deleted_at**：删除时间（软删除）

### 2.2 storage_nodes 表
- **id**：存储节点ID，主键
- **name**：存储节点名称
- **type**：存储类型（local/oss/minio）
- **config**：存储配置（JSON格式，包含路径、访问密钥等）
- **total_space**：总存储空间（字节）
- **used_space**：已用存储空间（字节）
- **status**：节点状态（active/inactive）
- **priority**：优先级（用于负载均衡）
- **created_at**：创建时间
- **updated_at**：更新时间

### 2.3 sync_tasks 表
- **id**：任务ID，主键
- **user_id**：用户ID，外键关联users表
- **device_id**：设备ID，外键关联devices表
- **task_type**：任务类型（upload/download）
- **file_id**：文件ID，外键关联files表
- **status**：任务状态（pending/running/success/failed）
- **progress**：任务进度（0-100）
- **created_at**：创建时间
- **updated_at**：更新时间

### 2.4 sync_logs 表
- **id**：日志ID，主键
- **sync_task_id**：同步任务ID，外键关联sync_tasks表
- **user_id**：用户ID，外键关联users表
- **file_id**：文件ID，外键关联files表
- **operation**：操作类型（upload/download/conflict）
- **result**：操作结果（success/failed）
- **message**：操作详情
- **created_at**：创建时间

### 2.5 download_tasks 表
- **id**：任务ID，主键
- **user_id**：用户ID，外键关联users表
- **url**：下载链接
- **file_name**：文件名
- **size**：文件大小（字节）
- **status**：任务状态（pending/running/success/failed）
- **progress**：下载进度（0-100）
- **speed**：下载速度（字节/秒）
- **save_path**：保存路径
- **created_at**：创建时间
- **updated_at**：更新时间
- **completed_at**：完成时间

### 2.6 file_versions 表
- **id**：版本ID，主键
- **file_id**：文件ID，外键关联files表
- **user_id**：用户ID，外键关联users表
- **version_number**：版本号
- **size**：版本大小（字节）
- **hash_value**：版本哈希值
- **storage_path**：版本存储路径
- **created_at**：创建时间
- **created_by**：创建人（用户ID或系统）

## 3. 文件管理与在线处理

### 3.1 recycle_bin 表
- **id**：回收ID，主键
- **user_id**：用户ID，外键关联users表
- **file_id**：文件ID，外键关联files表
- **file_name**：文件名
- **delete_time**：删除时间
- **expire_time**：过期时间（超过此时间自动删除）
- **status**：状态（recycled/restored）

## 4. 分享

### 4.1 share_links 表
- **id**：分享ID，主键
- **user_id**：用户ID，外键关联users表
- **file_id**：文件/文件夹ID，外键关联files表
- **share_code**：分享码（用于生成链接）
- **password**：访问密码（可选）
- **expire_time**：过期时间
- **permission**：权限（readonly/download）
- **click_count**：访问次数
- **status**：状态（active/inactive）
- **created_at**：创建时间

## 5. 音视频与内容消费

### 5.1 playback_records 表
- **id**：记录ID，主键
- **user_id**：用户ID，外键关联users表
- **file_id**：文件ID，外键关联files表
- **current_position**：当前播放位置（秒）
- **total_duration**：总时长（秒）
- **last_played_at**：最后播放时间
- **device_id**：设备ID，外键关联devices表（可选）

### 5.2 favorites 表
- **id**：收藏ID，主键
- **user_id**：用户ID，外键关联users表
- **file_id**：文件ID，外键关联files表
- **created_at**：收藏时间

### 5.3 subtitles 表
- **id**：字幕ID，主键
- **file_id**：视频文件ID，外键关联files表
- **name**：字幕名称
- **language**：字幕语言
- **type**：字幕类型（internal/external）
- **storage_path**：字幕存储路径
- **created_at**：创建时间

### 5.4 albums 表
- **id**：专辑/歌单ID，主键
- **user_id**：用户ID，外键关联users表
- **name**：专辑/歌单名称
- **type**：类型（video/audio）
- **description**：描述（可选）
- **cover_image**：封面图片（可选）
- **created_at**：创建时间
- **updated_at**：更新时间

### 5.5 album_files 表
- **id**：关联ID，主键
- **album_id**：专辑/歌单ID，外键关联albums表
- **file_id**：文件ID，外键关联files表
- **order_index**：排序索引
- **created_at**：添加时间

### 5.6 cast_devices 表
- **id**：设备ID，主键
- **user_id**：用户ID，外键关联users表
- **name**：设备名称
- **type**：设备类型（tv/projector）
- **ip_address**：设备IP地址
- **status**：设备状态（online/offline）
- **last_used_at**：最后使用时间
- **created_at**：创建时间

### 5.7 cache_files 表
- **id**：缓存ID，主键
- **user_id**：用户ID，外键关联users表
- **file_id**：文件ID，外键关联files表
- **device_id**：设备ID，外键关联devices表
- **local_path**：本地缓存路径
- **size**：缓存大小（字节）
- **created_at**：缓存时间
- **accessed_at**：最后访问时间

### 5.8 ai_tasks 表
- **id**：任务ID，主键
- **user_id**：用户ID，外键关联users表
- **file_id**：文件ID，外键关联files表
- **task_type**：任务类型（ocr/id_card_cleanup/paper_cleanup/summary/subtitle_generation）
- **status**：任务状态（pending/running/success/failed）
- **result_path**：结果存储路径
- **created_at**：创建时间
- **completed_at**：完成时间

## 6. 系统管理与监控

### 6.1 system_configs 表
- **id**：配置ID，主键
- **key**：配置键
- **value**：配置值
- **description**：配置描述
- **updated_by**：更新人（用户ID或系统）
- **updated_at**：更新时间

### 6.2 operation_logs 表
- **id**：日志ID，主键
- **user_id**：用户ID，外键关联users表（系统操作可为空）
- **operation_type**：操作类型（login/logout/upload/download/delete/modify）
- **target_type**：操作目标类型（user/file/folder/config）
- **target_id**：操作目标ID
- **details**：操作详情（JSON格式）
- **ip_address**：操作IP
- **device_id**：操作设备ID，外键关联devices表（可选）
- **created_at**：操作时间

### 6.3 user_storage 表
- **id**：存储记录ID，主键
- **user_id**：用户ID，外键关联users表
- **total_space**：总存储空间（字节）
- **used_space**：已用存储空间（字节）
- **file_count**：文件数量
- **updated_at**：更新时间

### 6.4 conversion_tasks 表
- **id**：任务ID，主键
- **user_id**：用户ID，外键关联users表
- **file_id**：文件ID，外键关联files表
- **task_type**：任务类型（convert/extract/unzip）
- **source_format**：源格式
- **target_format**：目标格式
- **status**：任务状态（pending/running/success/failed）
- **progress**：任务进度（0-100）
- **result_path**：结果存储路径
- **created_at**：创建时间
- **completed_at**：完成时间

### 6.5 share_access_logs 表
- **id**：日志ID，主键
- **share_link_id**：分享链接ID，外键关联share_links表
- **access_ip**：访问IP
- **access_time**：访问时间
- **device_info**：访问设备信息
- **status**：访问状态（success/failed）
- **error_message**：错误信息（可选）

### 6.6 user_settings 表
- **id**：设置ID，主键
- **user_id**：用户ID，外键关联users表（唯一）
- **theme**：界面主题（light/dark）
- **language**：语言偏好
- **notifications_enabled**：通知开关
- **sync_settings**：同步设置（JSON格式）
- **upload_settings**：上传设置（JSON格式）
- **updated_at**：更新时间

### 6.7 notifications 表
- **id**：通知ID，主键
- **user_id**：用户ID，外键关联users表
- **type**：通知类型（system/operation/alert）
- **title**：通知标题
- **content**：通知内容
- **is_read**：是否已读
- **created_at**：创建时间
- **expire_at**：过期时间

## 7. 表关系图

```
┌─────────────┐      ┌─────────────┐      ┌───────────────┐
│   users     │◄─────┤  devices    │◄─────┤ device_logs   │
└─────────────┘      └─────────────┘      └───────────────┘
       │                  │                        │
       │                  │                        │
       ▼                  ▼                        ▼
┌─────────────┐      ┌─────────────┐      ┌───────────────┐
│   files     │◄─────┤sync_tasks   │◄─────┤  sync_logs    │
└─────────────┘      └─────────────┘      └───────────────┘
       │                  │                        │
       │                  │                        │
       ▼                  ▼                        ▼
┌─────────────┐      ┌─────────────┐      ┌───────────────┐
│file_versions│◄─────┤download_tasks│◄─────┤  recycle_bin  │
└─────────────┘      └─────────────┘      └───────────────┘
       │                  │                        │
       │                  │                        │
       ▼                  ▼                        ▼
┌─────────────┐      ┌─────────────┐      ┌───────────────┐
│share_links  │      │playback_records│      │   favorites   │
└─────────────┘      └─────────────┘      └───────────────┘
       │                  │                        │
       │                  │                        │
       ▼                  ▼                        ▼
┌─────────────┐      ┌─────────────┐      ┌───────────────┐
│   albums    │◄─────┤album_files  │◄─────┤   subtitles   │
└─────────────┘      └─────────────┘      └───────────────┘
       │                  │                        │
       │                  │                        │
       ▼                  ▼                        ▼
┌─────────────┐      ┌─────────────┐      ┌───────────────┐
│  ai_tasks   │◄─────┤cache_files  │◄─────┤  cast_devices │
└─────────────┘      └─────────────┘      └───────────────┘
       │                  │                        │
       │                  │                        │
       ▼                  ▼                        ▼
┌─────────────┐      ┌─────────────┐      ┌───────────────┐
│conversion_tasks│◄─────┤share_access_logs│◄─────┤  user_settings │
└─────────────┘      └─────────────┘      └───────────────┘
       │                  │                        │
       │                  │                        │
       ▼                  ▼                        ▼
┌─────────────┐      ┌─────────────┐      ┌───────────────┐
│notifications│◄─────┤system_configs│◄─────┤  operation_logs │
└─────────────┘      └─────────────┘      └───────────────┘
       │                  │                        │
       │                  │                        │
       ▼                  ▼                        ▼
┌─────────────┐      ┌─────────────┐      ┌───────────────┐
│             │      │             │      │  user_storage │
└─────────────┘      └─────────────┘      └───────────────┘
```

## 8. 设计说明

1. **数据完整性**：通过外键约束确保数据一致性
2. **性能优化**：对常用查询字段建立索引，如user_id、file_id、created_at等
3. **扩展性**：表结构设计考虑未来功能扩展，如添加新的存储类型、新的AI工具等
4. **安全性**：密码等敏感信息使用哈希存储，避免明文
5. **可维护性**：表名和字段名语义清晰，便于理解和维护

此数据库表结构设计覆盖了ND网盘的所有核心功能，为系统的稳定运行提供了坚实的数据基础。

## 9. 数据库配置

### 9.1 基本配置
- **数据库名称**：nd
- **字符集**：utf8mb4
- **排序规则**：utf8mb4_unicode_ci
- **存储引擎**：InnoDB

### 9.2 连接配置
- **主机**：localhost
- **端口**：3306
- **用户名**：nd_user
- **密码**：123456

### 9.3 初始化脚本
数据库初始化脚本位于 `/Users/test/Desktop/nd/mysql/init/init.sql`，包含所有表的创建语句和默认数据。