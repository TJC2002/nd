# ND网盘 - 用户登录与授权认证方案

## 1. 技术选型

### 1.1 后端框架选择
根据系统特点和可扩展性，推荐以下框架：

| 框架 | 语言 | 优势 | 适用场景 |
|------|------|------|----------|
| Spring Boot | Java | 生态成熟，安全稳定，适合企业级应用 | 大型系统，需要高可靠性 |
| Express + Node.js | JavaScript | 轻量快速，开发效率高 | 中小型系统，快速迭代 |
| Flask | Python | 简洁灵活，易于学习 | 中小型系统，快速开发 |
| Django | Python | 功能全面，内置认证系统 | 中型系统，需要完整的管理后台 |

**推荐选择**：Spring Boot（Java）
- 理由：安全特性丰富，生态成熟，适合构建可靠的存储系统
- 内置Spring Security框架，提供完整的认证授权解决方案

### 1.2 认证技术
- **JWT（JSON Web Token）**：无状态认证，适合多端登录
- **Refresh Token**：用于刷新访问令牌，提高安全性
- **BCrypt**：密码加密存储
- **Redis**：存储令牌黑名单，处理令牌失效

## 2. 后端认证架构

### 2.1 核心组件
- **认证服务**：处理登录、注销、令牌管理
- **用户服务**：管理用户信息
- **设备服务**：管理设备登录状态
- **令牌服务**：生成、验证、刷新令牌

### 2.2 数据模型
- **users表**：存储用户基本信息、密码哈希
- **devices表**：存储设备信息、关联用户
- **device_logs表**：存储设备登录历史

### 2.3 API接口设计

#### 2.3.1 认证接口
| 接口 | 方法 | 路径 | 功能描述 | 请求体 (JSON) | 成功响应 (200 OK) |
|------|------|------|----------|--------------|-------------------|
| 登录 | POST | /api/auth/login | 用户登录，获取令牌 | `{"username": "user1", "password": "123456"}` | `{"accessToken": "jwt_token", "refreshToken": "refresh_token", "userId": 1, "expiresIn": 3600}` |
| 免注册登录 | POST | /api/auth/guest-login | 免注册直接登录 | `{"deviceId": "device_123", "deviceName": "My Phone"}` | `{"accessToken": "jwt_token", "refreshToken": "refresh_token", "userId": 1, "expiresIn": 3600}` |
| 令牌刷新 | POST | /api/auth/refresh | 使用刷新令牌获取新的访问令牌 | `{"refreshToken": "refresh_token"}` | `{"accessToken": "new_jwt_token", "expiresIn": 3600}` |
| 登出 | POST | /api/auth/logout | 用户登出，使令牌失效 | `{"refreshToken": "refresh_token"}` | `{"message": "Logout successful"}` |
| 密码找回 | POST | /api/auth/forgot-password | 发送密码找回链接 | `{"email": "user@example.com"}` | `{"message": "Reset link sent to your email"}` |
| 密码重置 | POST | /api/auth/reset-password | 重置密码 | `{"token": "reset_token", "newPassword": "new_password"}` | `{"message": "Password reset successful"}` |
| 账号注销 | POST | /api/auth/delete-account | 注销用户账号 | `{"password": "current_password"}` | `{"message": "Account deleted successfully"}` |

#### 2.3.2 设备管理接口
| 接口 | 方法 | 路径 | 功能描述 | 请求体 (JSON) | 成功响应 (200 OK) |
|------|------|------|----------|--------------|-------------------|
| 获取设备列表 | GET | /api/devices | 获取用户的所有登录设备 | N/A | `[{"id": 1, "deviceName": "My Phone", "deviceType": "mobile", "lastLoginIp": "192.168.1.1", "lastLoginTime": "2026-01-16T10:00:00Z", "status": "online"}]` |
| 远程下线设备 | POST | /api/devices/{deviceId}/logout | 强制下线指定设备 | N/A | `{"message": "Device logged out successfully"}` |

### 2.4 认证流程

#### 2.4.1 登录流程
1. 客户端发送登录请求（用户名+密码）
2. 后端验证用户凭证
3. 生成访问令牌（Access Token）和刷新令牌（Refresh Token）
4. 记录设备登录信息到devices表
5. 返回令牌和用户信息给客户端

#### 2.4.2 免注册登录流程
1. 客户端发送设备信息（设备ID、设备名称）
2. 后端检查是否存在该设备对应的用户
3. 若不存在，自动创建新用户并关联设备
4. 生成令牌并返回给客户端

#### 2.4.3 令牌验证流程
1. 客户端每次请求携带Access Token（在Authorization头中）
2. 后端验证令牌有效性（签名、过期时间）
3. 若令牌有效，继续处理请求
4. 若令牌过期，返回401错误
5. 客户端使用Refresh Token获取新的Access Token

#### 2.4.4 远程下线流程
1. 客户端请求下线指定设备
2. 后端标记该设备的令牌为失效
3. 将设备ID加入Redis黑名单
4. 返回成功响应
5. 该设备的后续请求将被拒绝

## 3. 客户端实现

### 3.1 Web端实现
- **技术栈**：Vue.js/React + Axios
- **登录页面**：
  - 用户名/密码登录表单
  - 免注册登录选项
  - 密码找回链接
- **令牌管理**：
  - 本地存储（localStorage/sessionStorage）存储令牌
  - 请求拦截器自动添加Authorization头
  - 响应拦截器处理401错误，自动刷新令牌
- **设备管理**：
  - 设备列表展示页面
  - 远程下线按钮
  - 设备状态实时更新

### 3.2 移动端实现
- **技术栈**：原生应用（iOS/Android）或Flutter
- **登录页面**：
  - 简洁的登录表单
  - 生物识别登录（指纹/面部识别）
  - 免注册登录选项
- **令牌管理**：
  - 安全存储令牌（Keychain/SharedPreferences）
  - 网络请求自动携带令牌
  - 后台刷新令牌
- **设备管理**：
  - 设备列表页
  - 远程下线功能
  - 设备登录通知

### 3.3 桌面端实现
- **技术栈**：Electron或原生应用
- **登录页面**：
  - 登录表单
  - 记住密码选项
  - 自动登录功能
- **令牌管理**：
  - 安全存储令牌
  - 系统托盘显示登录状态
  - 网络请求拦截器
- **设备管理**：
  - 设备列表弹窗
  - 远程下线功能

### 3.4 客户端通用实现要点
1. **安全存储**：使用平台提供的安全存储机制存储令牌
2. **自动登录**：记住用户登录状态，下次启动自动登录
3. **令牌刷新**：Access Token过期前自动使用Refresh Token刷新
4. **错误处理**：妥善处理认证错误，提供友好的用户提示
5. **状态管理**：使用状态管理库（如Vuex/Redux）管理用户状态

## 4. 安全性考虑

### 4.1 密码安全
- 使用BCrypt算法加密存储密码，设置适当的工作因子
- 密码复杂度要求（长度、包含大小写字母、数字、特殊字符）
- 密码尝试次数限制，防止暴力破解
- 密码找回流程安全（邮箱验证、重置令牌过期时间）

### 4.2 令牌安全
- JWT签名密钥安全存储，定期轮换
- Access Token设置合理的过期时间（如1小时）
- Refresh Token存储在安全的地方，设置较长的过期时间（如7天）
- 实现令牌黑名单，处理已注销但未过期的令牌
- 使用HTTPS传输令牌，防止中间人攻击

### 4.3 设备安全
- 设备唯一标识的安全生成和存储
- 设备登录异常检测（如异地登录）
- 远程下线功能，及时撤销可疑设备的访问权限
- 设备登录历史记录，便于用户审计

### 4.4 其他安全措施
- 防止CSRF攻击（使用CSRF Token）
- 防止XSS攻击（输入验证、输出编码）
- 日志记录敏感操作，便于安全审计
- 定期安全扫描和漏洞修复

## 5. 系统集成

### 5.1 与其他模块的集成
- **文件管理模块**：认证用户才能访问和管理文件
- **存储管理模块**：基于用户身份分配存储空间
- **分享模块**：验证分享链接的访问权限
- **系统管理模块**：管理员权限控制

### 5.2 多端同步
- 登录状态在多端同步
- 设备下线操作在所有端实时更新
- 令牌状态一致性保证

## 6. 部署与维护

### 6.1 部署考虑
- **生产环境**：使用HTTPS，配置适当的CORS策略
- **令牌配置**：根据环境调整令牌过期时间
- **Redis部署**：用于存储令牌黑名单和会话数据

### 6.2 监控与维护
- **登录异常监控**：监控异常登录行为
- **令牌使用监控**：监控令牌使用情况，检测异常
- **安全日志**：记录所有认证相关操作
- **定期检查**：定期检查令牌黑名单和过期令牌清理

## 7. 总结

本方案通过采用成熟的JWT认证机制，结合Spring Boot框架的安全特性，为ND网盘提供了一个安全、可靠、用户友好的登录和授权认证系统。客户端实现考虑了多平台的特性，确保在不同设备上都能提供一致的用户体验。

同时，方案充分考虑了安全性，包括密码加密、令牌管理、设备安全等方面，确保系统在提供便捷服务的同时，保护用户数据和隐私安全。

该方案不仅满足了ND网盘的基本需求，也为未来可能的功能扩展和用户增长做好了准备。