# ND网盘 - 技术架构文档

## 1. 技术栈选择

### 1.1 后端技术栈
- **核心框架**：Spring Boot 3.0+
- **数据访问**：MyBatis 3.5+（使用XML配置）
- **数据库**：MySQL 8.0+
- **缓存**：Redis 7.0+（用于会话管理、上传状态、文件哈希值）
- **认证**：Spring Security + JWT
- **API文档**：SpringDoc OpenAPI 2.0+（Swagger 3.0）
- **文件存储**：本地存储 + 阿里云OSS/MinIO
- **工具库**：
  - Apache Commons FileUpload（文件上传处理）
  - Jackson（JSON序列化）
  - Log4j2（日志记录）
  - Lombok（代码简化）

### 1.2 前端技术栈
- **核心框架**：React 18+
- **状态管理**：React Context + useReducer（轻量级状态管理）
- **UI组件库**：Material UI 5（扁平化风格）
- **路由**：React Router 6+
- **网络请求**：Axios
- **文件处理**：
  - SparkMD5（文件哈希计算）
  - react-dropzone（拖拽上传）
- **构建工具**：Vite
- **样式**：CSS Modules + SCSS

## 2. 后端架构设计

### 2.1 目录结构
```
backend/
├── src/
│   ├── main/
│   │   ├── java/
│   │   │   └── com/
│   │   │       └── example/
│   │   │           └──网盘/
│   │   │               ├── config/          # 配置类
│   │   │               │   └── SwaggerConfig.java  # Swagger配置
│   │   │               ├── controller/       # 控制器
│   │   │               ├── service/          # 服务层
│   │   │               ├── mapper/           # MyBatis映射接口
│   │   │               ├── model/            # 数据模型
│   │   │               ├── dto/              # 数据传输对象
│   │   │               ├── util/             # 工具类
│   │   │               └── Application.java  # 应用入口
│   │   ├── resources/
│   │   │   ├── mapper/           # MyBatis XML配置文件（单个文件）
│   │   │   ├── application.yml   # 应用配置
│   │   │   └── static/           # 静态资源
│   └── test/                     # 测试代码
├── pom.xml                       # Maven依赖配置
└── README.md                     # 项目说明
```

### 2.2 MyBatis XML配置
- **文件位置**：`src/main/resources/mapper/AllMapper.xml`
- **配置内容**：包含所有SQL语句，按功能模块组织
- **优势**：集中管理SQL，便于维护和优化

### 2.3 核心服务设计
- **认证服务**：处理用户登录、注销、令牌管理
- **文件服务**：处理文件上传、下载、管理
- **存储服务**：管理不同存储介质的文件存储
- **上传服务**：处理分片上传、秒传、断点续传
- **设备服务**：管理用户登录设备
- **分享服务**：处理文件分享功能

### 2.4 关键技术实现
- **分片上传**：使用Apache Commons FileUpload处理大文件分片
- **秒传**：基于文件哈希值的快速上传
- **断点续传**：基于上传ID和分片索引的续传机制
- **存储适配**：统一存储接口，支持本地和云存储
- **缓存策略**：Redis缓存热点数据和上传状态
- **事务管理**：文件操作的原子性保证

## 3. 前端架构设计

### 3.1 目录结构
```
frontend/
├── src/
│   ├── components/         # 通用组件
│   │   ├── layout/         # 布局组件
│   │   ├── upload/         # 上传相关组件
│   │   ├── file/           # 文件相关组件
│   │   └── common/         # 通用UI组件
│   ├── pages/              # 页面组件
│   │   ├── home/           # 首页
│   │   ├── login/          # 登录页
│   │   ├── files/          # 文件管理页
│   │   ├── share/          # 分享管理页
│   │   └── settings/       # 设置页
│   ├── context/            # React Context（状态管理）
│   ├── hooks/              # 自定义Hooks
│   ├── services/           # API服务
│   ├── utils/              # 工具函数
│   ├── styles/             # 全局样式
│   ├── App.jsx             # 应用根组件
│   ├── main.jsx            # 应用入口
│   └── routes.jsx          # 路由配置
├── public/                 # 静态资源
├── vite.config.js          # Vite配置
├── package.json            # 依赖配置
└── README.md               # 项目说明
```

### 3.2 核心功能实现
- **文件上传**：拖拽上传、分片上传、进度显示
- **文件管理**：文件列表、文件夹操作、文件预览
- **分享功能**：生成分享链接、设置权限
- **设备管理**：设备列表、远程下线
- **用户设置**：个人信息、存储空间管理
- **响应式设计**：适配不同屏幕尺寸

### 3.3 关键技术实现
- **文件哈希计算**：使用Web Worker避免阻塞主线程
- **分片上传**：Axios + FormData实现分片并行上传
- **状态管理**：React Context管理全局状态
- **路由管理**：React Router实现页面导航
- **UI组件**：Material UI 5实现扁平化风格界面
- **错误处理**：统一的错误处理机制
- **性能优化**：
  - 组件懒加载
  - 虚拟列表（大文件列表）
  - 缓存策略

## 4. 数据库设计

### 4.1 核心表结构
- **users**：用户信息
- **devices**：设备信息
- **device_logs**：设备登录历史
- **files**：文件元数据
- **file_versions**：文件历史版本
- **recycle_bin**：回收站
- **share_links**：分享链接
- **storage_nodes**：存储节点
- **sync_tasks**：同步任务
- **sync_logs**：同步日志
- **download_tasks**：离线下载任务
- **user_storage**：用户存储空间
- **system_configs**：系统配置
- **operation_logs**：操作日志

### 4.2 MyBatis XML配置示例
```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.网盘.mapper.UserMapper">
    <!-- 用户相关SQL -->
    <select id="getUserByUsername" resultType="com.example.网盘.model.User">
        SELECT * FROM users WHERE username = #{username}
    </select>
    
    <!-- 文件相关SQL -->
    <select id="getFileByHash" resultType="com.example.网盘.model.File">
        SELECT * FROM files WHERE file_hash = #{hash}
    </select>
    
    <!-- 其他SQL语句 -->
</mapper>
```

## 5. 关键功能实现

### 5.1 文件上传流程
1. **前端**：计算文件哈希值，检查秒传
2. **后端**：验证哈希值，检查文件是否存在
3. **前端**：初始化上传，获取上传ID
4. **前端**：分片上传文件
5. **后端**：接收分片，存储临时文件
6. **前端**：所有分片上传完成，请求合并
7. **后端**：合并分片，验证文件完整性，保存元数据

### 5.2 认证实现
- **JWT令牌**：无状态认证，支持多端登录
- **Refresh Token**：用于刷新访问令牌
- **设备绑定**：令牌与设备ID关联，支持远程下线

### 5.3 存储实现
- **统一存储接口**：抽象存储服务，支持多种存储介质
- **存储策略**：根据文件大小自动选择存储介质
- **路径生成**：基于文件哈希值生成存储路径，避免冲突

## 6. 开发与部署

### 6.1 开发环境
- **后端**：IntelliJ IDEA + Maven
- **前端**：VS Code + Vite Dev Server
- **数据库**：MySQL本地实例
- **缓存**：本地Redis实例

### 6.2 部署方案
- **后端**：Docker容器化部署
- **前端**：静态文件部署到Nginx
- **数据库**：MySQL RDS
- **缓存**：Redis Cluster
- **存储**：本地存储 + 云存储

### 6.3 CI/CD
- **代码仓库**：Git
- **构建工具**：Jenkins/GitLab CI
- **部署工具**：Docker Compose/Kubernetes

## 7. 性能优化

### 7.1 后端优化
- **数据库索引**：合理设计索引，优化查询
- **缓存策略**：热点数据缓存
- **异步处理**：文件上传、转码等耗时操作异步处理
- **连接池**：数据库和Redis连接池优化

### 7.2 前端优化
- **代码分割**：组件懒加载
- **虚拟滚动**：大文件列表优化
- **缓存**：API响应缓存
- **网络优化**：HTTP/2、压缩传输

## 8. Swagger API文档配置

### 8.1 依赖配置
- **Maven依赖**：
  ```xml
  <dependency>
      <groupId>org.springdoc</groupId>
      <artifactId>springdoc-openapi-starter-webmvc-ui</artifactId>
      <version>2.3.0</version>
  </dependency>
  <dependency>
      <groupId>org.springdoc</groupId>
      <artifactId>springdoc-openapi-starter-webmvc-api</artifactId>
      <version>2.3.0</version>
  </dependency>
  ```

### 8.2 Swagger配置类
```java
package com.example.网盘.config;

import io.swagger.v3.oas.models.OpenAPI;
import io.swagger.v3.oas.models.info.Info;
import io.swagger.v3.oas.models.info.License;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class SwaggerConfig {

    @Bean
    public OpenAPI customOpenAPI() {
        return new OpenAPI()
                .info(new Info()
                        .title("ND网盘 API")
                        .version("1.0")
                        .description("ND网盘后端API接口文档")
                        .license(new License()
                                .name("Apache 2.0")
                                .url("http://springdoc.org")));
    }
}
```

### 8.3 接口导出方法

#### 8.3.1 通过Swagger UI界面导出
1. **访问Swagger UI**：启动应用后访问 `http://localhost:8080/swagger-ui.html`
2. **导出接口**：
   - 点击页面顶部的 "Export" 按钮
   - 选择导出格式（JSON或YAML）
   - 下载导出文件

#### 8.3.2 通过API接口导出
1. **JSON格式**：访问 `http://localhost:8080/v3/api-docs`
2. **YAML格式**：访问 `http://localhost:8080/v3/api-docs.yaml`

### 8.4 控制器注解示例
```java
package com.example.网盘.controller;

import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.tags.Tag;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/api/auth")
@Tag(name = "认证管理", description = "用户认证相关接口")
public class AuthController {

    @PostMapping("/login")
    @Operation(summary = "用户登录", description = "用户登录接口，返回JWT令牌")
    public LoginResponse login(@RequestBody LoginRequest request) {
        // 实现登录逻辑
    }
}
```

### 8.5 接口文档使用说明
- **开发阶段**：集成到CI/CD流程，自动生成API文档
- **前后端协作**：前端开发人员可直接查看接口定义和参数
- **接口测试**：通过Swagger UI直接测试API接口
- **接口导出**：将接口文档导出为标准格式，用于团队协作

## 9. 总结

本技术架构基于您选择的技术栈，设计了一个完整的ND网盘。后端使用Spring Boot + MyBatis + Redis，提供稳定可靠的API服务；前端使用React + Material UI 5，提供现代化的用户界面。

架构设计考虑了系统的可扩展性、性能和安全性，适合个人用户的日常使用需求。通过合理的目录结构和模块化设计，便于开发和维护。

后续可根据实际需求，进一步细化各个模块的实现细节。